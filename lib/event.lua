local a=require("computer")local b=require("keyboard")local c=require("component")local d,e,f={},{},{}local g=-math.huge;local function h(i,...)local j,k=pcall(i,...)if not j and type(d.onError)=="function"then pcall(d.onError,k)return end;return k end;local function l(m,...)if e[m]then local function n()local o={}for p,q in ipairs(e[m])do o[p]=q end;return o end;for r,i in ipairs(n())do if h(i,m,...)==false then d.ignore(m,i)end end end end;local function s()local function t()local o={}for u,v in pairs(f)do if v.after<=a.uptime()then table.insert(o,v.callback)v.times=v.times-1;if v.times<=0 then f[u]=nil else v.after=a.uptime()+v.interval end end end;return o end;for r,i in ipairs(t())do h(i)end end;local function w(x,...)local y=table.pack(...)if x==nil and y.n==0 then return nil end;return function(...)local m=table.pack(...)if x and not(type(m[1])=="string"and m[1]:match(x))then return false end;for z=1,y.n do if y[z]~=nil and y[z]~=m[z+1]then return false end end;return true end end;local function A(...)local y=table.pack(...)if y.n==0 then return nil end;return function(...)local m=table.pack(...)if type(m[1])~="string"then return false end;for z=1,y.n do if y[z]~=nil and m[1]:match(y[z])then return true end end;return false end end;function d.cancel(B)checkArg(1,B,"number")if f[B]then f[B]=nil;return true end;return false end;function d.ignore(x,i)checkArg(1,x,"string")checkArg(2,i,"function")if e[x]then for z=1,#e[x]do if e[x][z]==i then table.remove(e[x],z)if#e[x]==0 then e[x]=nil end;return true end end end;return false end;function d.listen(x,i)checkArg(1,x,"string")checkArg(2,i,"function")if e[x]then for z=1,#e[x]do if e[x][z]==i then return false end end else e[x]={}end;table.insert(e[x],i)return true end;function d.onError(k)local C=io.open("/tmp/event.log","a")if C then C:write(k.."\n")C:close()end end;function d.pull(...)local D=table.pack(...)if type(D[1])=="string"then return d.pullFiltered(w(...))else checkArg(1,D[1],"number","nil")checkArg(2,D[2],"string","nil")return d.pullFiltered(D[1],w(select(2,...)))end end;function d.pullMultiple(...)local E;local D;if type(...)=="number"then E=...D=table.pack(select(2,...))for z=1,D.n do checkArg(z+1,D[z],"string","nil")end else D=table.pack(...)for z=1,D.n do checkArg(z,D[z],"string","nil")end end;return d.pullFiltered(E,A(table.unpack(D,1,D.n)))end;function d.pullFiltered(...)local D=table.pack(...)local E,y;if type(D[1])=="function"then y=D[1]else checkArg(1,D[1],"number","nil")checkArg(2,D[2],"function","nil")E=D[1]y=D[2]end;local F=E and a.uptime()+E or(y and math.huge or 0)repeat local G=E and F or math.huge;for r,v in pairs(f)do G=math.min(G,v.after)end;local m=table.pack(a.pullSignal(G-a.uptime()))if m.n>0 then l(table.unpack(m,1,m.n))end;s()d.takeScreenshot()_G.RCON=_G.RCON or nil;if m[1]=="modem_message"then local H,I,J,K,L,M=m[2],m[3],m[4],m[5],m[6],m[7]if J==512 then if L=="RCON"then if _G.RCON==nil then if M=="iWantToControl"then local N=ecs.universalWindow("auto","auto",46,ecs.windowColors.background,true,{"EmptyLine"},{"CenterText",0x880000,"RCON"},{"EmptyLine"},{"CenterText",0x262626,"Копьютер "..ecs.stringLimit("end",I,8).." запрашивает управление"},{"EmptyLine"},{"Button",{0x880000,0xffffff,"Разрешить"},{0xbbbbbb,0xffffff,"Отклонить"}})if N[1]=="Разрешить"then c.modem.send(I,J,"RCON","acceptControl")_G.RCON=true else c.modem.send(I,J,"RCON","denyControl")_G.RCON=false end end elseif _G.RCON==true then if M=="getResolution"then local O,P=c.gpu.getResolution()c.modem.send(I,J,"RCON",O,P)elseif M=="execute"then shell.execute(m[8])elseif M=="shutdown"then a.shutdown()elseif M=="reboot"then a.shutdown(true)elseif M=="key_down"then a.pushSignal("key_down",c.getPrimary("keyboard").address,m[8],m[9],m[10])elseif M=="touch"then a.pushSignal("touch",I,m[8],m[9],m[10],m[11])elseif M=="scroll"then a.pushSignal("scroll",I,m[8],m[9],m[10],m[11])elseif M=="clipboard"then a.pushSignal("clipboard",I,m[8],m[9])elseif M=="closeConnection"then ecs.error("Клиент под ID "..I.." отключился. Закрываю сеть RCON.")_G.RCON=nil end end end end end;if d.shouldInterrupt()then g=a.uptime()error("interrupted",0)end;if d.shouldSoftInterrupt()and(y==nil or y("interrupted",a.uptime()-g))then local Q=a.uptime()-g;g=a.uptime()return"interrupted",Q end;if not(E or y)or y==nil or y(table.unpack(m,1,m.n))then return table.unpack(m,1,m.n)end until a.uptime()>=F end;function d.shouldInterrupt()return a.uptime()-g>1 and b.isControlDown()and b.isAltDown()and b.isKeyDown(b.keys.c)end;function d.shouldSoftInterrupt()return a.uptime()-g>1 and b.isControlDown()and b.isKeyDown(b.keys.c)end;function d.takeScreenshot()if b.isKeyDown(100)or b.isKeyDown(183)then a.beep(1500)local R="screenshot.pic"image.screenshot(R)a.beep(2000)a.beep(2000)a.pushSignal("screenshot",R)end end;function d.timer(S,i,T)checkArg(1,S,"number")checkArg(2,i,"function")checkArg(3,T,"number","nil")local u;repeat u=math.floor(math.random(1,0x7FFFFFFF))until not f[u]f[u]={interval=S,after=a.uptime()+S,callback=i,times=T or 1}return u end;return d
